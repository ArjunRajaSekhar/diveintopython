
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>3.15. Putting it all together</title><link rel="stylesheet" href="/css/diveintopython.css" type="text/css" /><link rev="made" href="josh@servercobra.com" /><meta name="generator" content="DocBook XSL Stylesheets V" /><meta name="keywords" content="Python, язык Python, язык программирования Python, Dive Into Python, В глубь языка Python, учебник, объектно-ориентированный, программирование, документация, книга, free, свободный, бесплатный" /><meta name="description" content="a free Python book for experienced programmers" /><link rel="home" href="http://ru.diveintopython.net/" title="В глубь языка Python" /><link rel="up" href="http://ru.diveintopython.net/" title="Глава 3. Средства объектно-ориентированного программирования" /><link rel="previous" href="http://ru.diveintopython.net/" title="3.14. The os module" /><link rel="next" href="http://ru.diveintopython.net/" title="3.16. Summary" /><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-9740779-18']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script></head><body>
<style type="text/css">body{margin-top:0!important;padding-top:0!important;min-width:800px!important;}#wm-ipp a:hover{text-decoration:underline!important;}</style>
<table id="Header" width="100%" border="0" cellpadding="0" cellspacing="0"><tr><td id="breadcrumb" colspan="5" align="left"><a href="http://ru.diveintopython.net/index.html">&#1053;&#1072;&#1095;&#1072;&#1083;&#1086;</a>&nbsp;&gt;&nbsp;<a href="http://ru.diveintopython.net/toc.html">&#1042; &#1075;&#1083;&#1091;&#1073;&#1100; &#1103;&#1079;&#1099;&#1082;&#1072; Python</a>&nbsp;&gt;&nbsp;<a href="http://ru.diveintopython.net/fileinfo_divein.html">&#1057;&#1088;&#1077;&#1076;&#1089;&#1090;&#1074;&#1072; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1085;&#1086;-&#1086;&#1088;&#1080;&#1077;&#1085;&#1090;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1085;&#1086;&#1075;&#1086; &#1087;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1088;&#1086;&#1074;&#1072;&#1085;&#1080;&#1103;</a>&nbsp;&gt;&nbsp;<b>Putting it all together</b></td><td id="navigation" align="right">&nbsp;&nbsp;&nbsp;<a href="http://ru.diveintopython.net/fileinfo_os.html" title="Пред.: “The os module”">&lt;&lt;</a>&nbsp;&nbsp;&nbsp;<a href="http://ru.diveintopython.net/fileinfo_summary.html" title="След.: “Summary”">&gt;&gt;</a></td></tr><tr><td><img src="http://ru.diveintopython.net/images/logo.png" alt="diveinto.python.ru" /></td><td colspan="2"><span id="logo">&#1042; &#1075;&#1083;&#1091;&#1073;&#1100; &#1103;&#1079;&#1099;&#1082;&#1072; Python</span><br /><span id="tagline">&#1044;&#1083;&#1103; &#1087;&#1088;&#1086;&#1075;&#1088;&#1072;&#1084;&#1084;&#1080;&#1089;&#1090;&#1086;&#1074;</span></td><td colspan="3" align="right"></td></tr></table><div class="section"><a name="fileinfo.alltogether"></a><div class="titlepage"><div><h2 class="title"><a name="fileinfo.alltogether"></a>3.15. Putting it all together</h2></div></div><div class="abstract"><p>Once again, all the dominoes are in place.  We've seen how each line of code works.  Now let's step back and see how it all fits together.</p></div><div class="example"><p><a name="fileinfo.nested"></a><b>&#1055;&#1088;&#1080;&#1084;&#1077;&#1088; 3.39. <tt>listDirectory</tt></b></p><pre class="programlisting"><span class="pykeyword">
def</span> listDirectory(directory, fileExtList):                                         <a name="fileinfo.alltogether.1.1"></a><img src="http://ru.diveintopython.net/images/callouts/1.png" alt="1" border="0" width="12" height="12" />
    <span class="pystring">"""&#1074;&#1086;&#1079;&#1074;&#1088;&#1072;&#1097;&#1072;&#1077;&#1090; &#1089;&#1087;&#1080;&#1089;&#1086;&#1082; &#1086;&#1073;&#1098;&#1077;&#1082;&#1090;&#1086;&#1074; &#1089; &#1084;&#1077;&#1090;&#1072;&#1080;&#1085;&#1092;&#1086;&#1088;&#1084;&#1072;&#1094;&#1080;&#1077;&#1081; &#1076;&#1083;&#1103; &#1074;&#1089;&#1077;&#1093; &#1092;&#1072;&#1081;&#1083;&#1086;&#1074; &#1089;
&#1091;&#1082;&#1072;&#1079;&#1072;&#1085;&#1085;&#1099;&#1084; &#1088;&#1072;&#1089;&#1096;&#1080;&#1088;&#1077;&#1085;&#1080;&#1077;&#1084;"""</span>                       
    fileList = [os.path.normcase(f) <span class="pykeyword">for</span> f <span class="pykeyword">in</span> os.listdir(directory)]               
    fileList = [os.path.join(directory, f) <span class="pykeyword">for</span> f <span class="pykeyword">in</span> fileList \
                <span class="pykeyword">if</span> os.path.splitext(f)[1] <span class="pykeyword">in</span> fileExtList]                          <a name="fileinfo.alltogether.1.2"></a><img src="http://ru.diveintopython.net/images/callouts/2.png" alt="2" border="0" width="12" height="12" />
    <span class="pykeyword">def</span><span class="pyclass"> getFileInfoClass</span>(filename, module=sys.modules[FileInfo.__module__]):       <a name="fileinfo.alltogether.1.3"></a><img src="http://ru.diveintopython.net/images/callouts/3.png" alt="3" border="0" width="12" height="12" />
        <span class="pystring">"&#1086;&#1088;&#1077;&#1076;&#1077;&#1083;&#1103;&#1077;&#1090; &#1082;&#1083;&#1072;&#1089;&#1089;, &#1087;&#1088;&#1077;&#1076;&#1085;&#1072;&#1079;&#1085;&#1072;&#1095;&#1077;&#1085;&#1099;&#1081; &#1076;&#1083;&#1103; &#1086;&#1073;&#1088;&#1072;&#1073;&#1086;&#1090;&#1082;&#1080; &#1092;&#1072;&#1081;&#1083;&#1072;, &#1087;&#1086; &#1088;&#1072;&#1089;&#1096;&#1080;&#1088;&#1077;&#1085;&#1080;&#1102;"</span>      
        subclass = <span class="pystring">"%sFileInfo"</span> % os.path.splitext(filename)[1].upper()[1:]        <a name="fileinfo.alltogether.1.4"></a><img src="http://ru.diveintopython.net/images/callouts/4.png" alt="4" border="0" width="12" height="12" />
        <span class="pykeyword">return</span> hasattr(module, subclass) <span class="pykeyword">and</span> getattr(module, subclass) <span class="pykeyword">or</span> FileInfo <a name="fileinfo.alltogether.1.5"></a><img src="http://ru.diveintopython.net/images/callouts/5.png" alt="5" border="0" width="12" height="12" />
    <span class="pykeyword">return</span> [getFileInfoClass(f)(f) <span class="pykeyword">for</span> f <span class="pykeyword">in</span> fileList]                              <a name="fileinfo.alltogether.1.6"></a><img src="http://ru.diveintopython.net/images/callouts/6.png" alt="6" border="0" width="12" height="12" /></pre><div class="calloutlist"><a name="d0e5062"></a><table border="0" summary="Callout list"><tr><td width="12" valign="top" align="left"><a href="http://ru.diveintopython.net/fileinfo_alltogether.html#fileinfo.alltogether.1.1"><img src="http://ru.diveintopython.net/images/callouts/1.png" alt="1" border="0" width="12" height="12" /></a> </td><td valign="top" align="left"><tt>listDirectory</tt> is the main attraction of this entire module.  It takes a directory (like <tt>c:\music\_singles\</tt> in my case) and a list of interesting file extensions (like <tt>['.mp3']</tt>), and it returns a list of class instances that act like dictionaries that contain metadata about each interesting file in that directory.  And it does it in just a few straightforward lines of code.</td></tr><tr><td width="12" valign="top" align="left"><a href="http://ru.diveintopython.net/fileinfo_alltogether.html#fileinfo.alltogether.1.2"><img src="http://ru.diveintopython.net/images/callouts/2.png" alt="2" border="0" width="12" height="12" /></a> </td><td valign="top" align="left">As we saw in the <a href="http://ru.diveintopython.net/fileinfo_os.html" title="3.14. The os module">previous section</a>, this line of code gets a list of the full pathnames of all the files in <tt>directory</tt> that have an interesting file extension (as specified by <tt>fileExtList</tt>).</td></tr><tr><td width="12" valign="top" align="left"><a href="http://ru.diveintopython.net/fileinfo_alltogether.html#fileinfo.alltogether.1.3"><img src="http://ru.diveintopython.net/images/callouts/3.png" alt="3" border="0" width="12" height="12" /></a> </td><td valign="top" align="left">Old-school Pascal programmers may be familiar with them, but most people give me a blank stare when I tell them that Python supports <span class="emphasis"><i>nested functions</i></span> -- literally, a function within a function.  The nested function <tt>getFileInfoClass</tt> can only be called from the function in which it is defined, <tt>listDirectory</tt>.  As with any other function, you don't need an interface declaration or anything fancy; just define the function and code it.</td></tr><tr><td width="12" valign="top" align="left"><a href="http://ru.diveintopython.net/fileinfo_alltogether.html#fileinfo.alltogether.1.4"><img src="http://ru.diveintopython.net/images/callouts/4.png" alt="4" border="0" width="12" height="12" /></a> </td><td valign="top" align="left">Now that you've seen the <a href="http://ru.diveintopython.net/fileinfo_os.html" title="3.14. The os module"><tt>os</tt></a> module, this line should make more sense.  It gets the extension of the file (<tt>os.path.splitext(filename)[1]</tt>), forces it to uppercase (<tt>.upper()</tt>), slices off the dot (<tt>[1:]</tt>), and constructs a class name out of it with string formatting.  So <tt>c:\music\ap\mahadeva.mp3</tt> becomes <tt>.mp3</tt> becomes <tt>.MP3</tt> becomes <tt>MP3</tt> becomes <tt>MP3FileInfo</tt>.</td></tr><tr><td width="12" valign="top" align="left"><a href="http://ru.diveintopython.net/fileinfo_alltogether.html#fileinfo.alltogether.1.5"><img src="http://ru.diveintopython.net/images/callouts/5.png" alt="5" border="0" width="12" height="12" /></a> </td><td valign="top" align="left">Having constructed the name of the handler class that would handle this file, we check to see if that handler class actually exists in this module.  If it does, we return the class, otherwise we return the base class <tt>FileInfo</tt>.  This is a very important point: <span class="emphasis"><i>this function returns a class</i></span>.  Not an instance of a class, but the class itself.</td></tr><tr><td width="12" valign="top" align="left"><a href="http://ru.diveintopython.net/fileinfo_alltogether.html#fileinfo.alltogether.1.6"><img src="http://ru.diveintopython.net/images/callouts/6.png" alt="6" border="0" width="12" height="12" /></a> </td><td valign="top" align="left">For each file in our &#8220;interesting files&#8221; list (<tt>fileList</tt>), we call <tt>getFileInfoClass</tt> with the filename (<tt>f</tt>).  Calling <tt>getFileInfoClass(f)</tt> returns a class; we don't know exactly which class, but we don't care.  We then create an instance of this class (whatever it is) and pass the filename (<tt>f</tt> again), to the <tt>__init__</tt> method.  As we saw <a href="http://ru.diveintopython.net/fileinfo_specialmethods.html#fileinfo.specialmethods.setname" title="Пример 3.16. Setting an MP3FileInfo's name">earlier in this chapter</a>, the <tt>__init__</tt> method of <tt>FileInfo</tt> sets <tt>self["name"]</tt>, which triggers <tt>__setitem__</tt>, which is overridden in the descendant (<tt>MP3FileInfo</tt>) to parse the file appropriately to pull out the file's metadata.  We do all that for each interesting file and return a list of the resulting instances.</td></tr></table></div></div><p>Note that <tt>listDirectory</tt> is completely generic.  It doesn't know ahead of time which types of files it will be getting, or which classes are defined that could potentially handle those files.  It inspects the directory for the files to process, then introspects its own module to see what special handler classes (like <tt>MP3FileInfo</tt>) are defined.  You can extend this program to handle other types of files simply by defining an appropriately-named class: <tt>HTMLFileInfo</tt> for HTML files, <tt>DOCFileInfo</tt> for Word <tt>.doc</tt> files, and so forth.  <tt>listDirectory</tt> will handle them all, without modification, by handing the real work off to the appropriate classes and collating the results.</p></div><table class="Footer" width="100%" border="0" cellpadding="0" cellspacing="0"><tr><td width="35%" align="left"><br /><a href="http://ru.diveintopython.net/fileinfo_os.html"><span class="NavigationArrow">&lt;&lt;</span>&nbsp;The os module</a></td><td width="30%" align="center"><br />&nbsp;<a href="http://ru.diveintopython.net/fileinfo_divein.html#fileinfo.divein" title="3.1. В глубь">1</a> <a href="http://ru.diveintopython.net/fileinfo_fromimport.html" title="3.2. Импортирование модулей инструкцией from module import">2</a> <a href="http://ru.diveintopython.net/fileinfo_class.html" title="3.3. Определение классов">3</a> <a href="http://ru.diveintopython.net/fileinfo_instantiation.html" title="3.4. Создание экземпляров классов">4</a> <a href="http://ru.diveintopython.net/fileinfo_userdict.html" title="3.5. UserDict: a wrapper class">5</a> <a href="http://ru.diveintopython.net/fileinfo_specialmethods.html" title="3.6. Special class methods">6</a> <a href="http://ru.diveintopython.net/fileinfo_morespecial.html" title="3.7. Advanced special class methods">7</a> <a href="http://ru.diveintopython.net/fileinfo_classattributes.html" title="3.8. Class attributes">8</a> <a href="http://ru.diveintopython.net/fileinfo_private.html" title="3.9. Private functions">9</a> <a href="http://ru.diveintopython.net/fileinfo_exception.html" title="3.10. Handling exceptions">10</a> <a href="http://ru.diveintopython.net/fileinfo_files.html" title="3.11. File objects">11</a> <a href="http://ru.diveintopython.net/fileinfo_for.html" title="3.12. for loops">12</a> <a href="http://ru.diveintopython.net/fileinfo_modules.html" title="3.13. More on modules">13</a> <a href="http://ru.diveintopython.net/fileinfo_os.html" title="3.14. The os module">14</a> <b>15</b> <a href="http://ru.diveintopython.net/fileinfo_summary.html" title="3.16. Summary">16</a>&nbsp;</td><td width="35%" align="right"><br /><a href="http://ru.diveintopython.net/fileinfo_summary.html">Summary&nbsp;<span class="NavigationArrow">&gt;&gt;</span></a></td></tr><tr><td colspan="3"><br /></td></tr></table><table class="Footer" width="100%" border="0" cellpadding="0" cellspacing="0"><tr><td align="left"><p class="copyright">Copyright &copy; 2000, 2001, 2002 <a href="mailto:josh@servercobra.com">&#1052;&#1072;&#1088;&#1082; &#1055;&#1080;&#1083;&#1075;&#1088;&#1080;&#1084;</a></p><p class="copyright">Copyright &copy; 2001, 2002, 2003 &#1055;&#1077;&#1088;&#1077;&#1074;&#1086;&#1076;, <a href="mailto:josh@servercobra.com">&#1044;&#1077;&#1085;&#1080;&#1089; &#1054;&#1090;&#1082;&#1080;&#1076;&#1072;&#1095;</a></p></td><td align="left">&nbsp;</td></tr></table></body></html>
